---
layout: post
title: CI/CD vá»›i project NodeJS
subtitle: Nghá»‹ch ngá»£m CI/CD vá»›i CircleCI
published: true
tags: [nodejs, ci/cd, circleCI]
---

|Nodejs|CI/CD|CircleCI|

----------

> BÃ i viáº¿t hÆ°á»›ng dáº«n tÃ­ch há»£p CI/CD vá»›i circleCI má»™t cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t.


### 1. CÃ¡i nhÃ¬n tá»•ng quan
* MÃ¬nh sáº½ khÃ´ng Ä‘i sÃ¢u vÃ o lÃ½ thuyáº¿t vá» `CI/CD` lÃ  gÃ¬?, cÃ´ng dá»¥ng cá»§a `CI/CD` vÃ¬ cÃ¡i nÃ y má»i ngÆ°á»i cÃ³ thá»ƒ tÃ¬m tháº¥y ráº¥t nhiá»u trÃªn google.
* Gáº§n Ä‘Ã¢y, má»™t vÃ i project mÃ¬nh Ä‘ang lÃ m cÃ³ thÃªm thÃ nh viÃªn, cáº§n má»Ÿ rá»™ng tÃ­nh nÄƒng. Äá»ƒ kiá»ƒm soÃ¡t tá»‘t hÆ¡n source code cá»§a má»i ngÆ°á»i cÅ©ng nhÆ° tÃ­ch há»£p tá»± Ä‘á»™ng cho project mÃ¬nh Ä‘Ã£ Ã¡p dá»¥ng `CI/CD` vÃ o. VÃ  cá»¥ thá»ƒ hÆ¡n mÃ¬nh sá»­ dá»¥ng CircleCI - cÃ¡i mÃ  mÃ¬nh bá»‹ quáº£ng cÃ¡o liÃªn tá»¥c khi xem youtube ğŸ˜…
* Technical Stack: Nodejs (express - typescript), pm2 ...
* TrÆ°á»›c khi cÃ³ `CI/CD`, khi triá»ƒn khai project mÃ¬nh sáº½ thá»±c hiá»‡n cÃ¡c bÆ°á»›c sau:

![CÃ¡c bÆ°á»›c triá»ƒn khai dá»± Ã¡n Ä‘Æ¡n giáº£n](/img/ci-cd-pic1.png "CÃ¡c bÆ°á»›c triá»ƒn khai dá»± Ã¡n Ä‘Æ¡n giáº£n")
<h5 style="text-align: center;">Triá»ƒn khai dá»± Ã¡n Ä‘Æ¡n giáº£n</h5>


* Sau khi code xong, chÃºng ta sáº½ cháº¡y test. Khi Ä‘Ã£ pass toÃ n bá»™ test case thÃ¬ sáº½ thá»±c hiá»‡n push code lÃªn git, táº¡o pull request, review code vÃ  Ä‘Æ°á»£c merge vÃ  master.
* Sau Ä‘Ã³ sáº½ `ssh` vÃ o server - nÆ¡i deploy project. KÃ©o project tá»« git vá» vÃ  start server lÃªn.
* Ok, má»i thá»© Ä‘á»u khÃ¡ lÃ  thá»§ cÃ´ng vÃ  máº¥t thá»i gian. Do Ä‘Ã³ `CI/CD` lÃ  giáº£i phÃ¡p tiáº¿p theo cá»§a mÃ¬nh Ä‘á»ƒ má»i thá»© trá»Ÿ nÃªn tá»± Ä‘á»™ng hÆ¡n. 
* Hiá»ƒu má»™t cÃ¡ch nÃ´ng dÃ¢n sáº½ lÃ  nhÆ° nÃ y: CircleCI sáº½ giÃºp mÃ¬nh cháº¡y cÃ¡c test case cá»§a má»—i commit Ä‘Æ°á»£c push lÃªn repository. NgoÃ i ra, sau khi má»—i branch Ä‘Æ°á»£c meger vÃ o master cÅ©ng sáº½ Ä‘Æ°á»£c cháº¡y test. Náº¿u pass toÃ n bá»™ test nÃ³ sáº½ tá»± Ä‘á»™ng deploy lÃªn server vÃ  restart cÃ¡c tiáº¿n trÃ¬nh cá»§a pm2.

### 2. Triá»ƒn khai trÃªn CircleCI
#### 2.1 CÃ¡c bÆ°á»›c chuáº©n bá»‹ 
* project Ä‘Æ¡n giáº£n vá»›i typescript Ä‘Æ°á»£c mÃ¬nh viáº¿t trong bÃ i nÃ y: https://dattp.github.io/2020-08-08-typescript
* Má»i ngÆ°á»i cÃ³ thá»ƒ clone project táº¡o github luÃ´n: https://github.com/dattp/todo_typescript

> VÃ¬ bÃ i nÃ y má»¥c Ä‘Ã­ch chÃ­nh lÃ  vá» `CI/CD` nÃªn mÃ¬nh chá»‰ viáº¿t test case cho pháº§n service. ÄÃºng ra sáº½ pháº£i viáº¿t test case cho toÃ n bá»™ nhá»¯ng class khÃ¡c Ä‘á»ƒ cÃ³ thá»ƒ coverage toÃ n bá»™ code.
> Pháº§n vá» unit test cÃ³ tÃ­ch há»£p vá»›i cáº£ database mÃ¬nh sáº½ lÃ m vÃ o bÃ i viáº¿t tá»›i. Má»i ngÆ°á»i cÃ¹ng theo dÃµi nhÃ©.

* Ok! Sau khi Ä‘Ã£ cÃ³ project, chÃºng ta sáº½ truy cáº­p vÃ o [trang login cá»§a CircleCI](https://circleci.com/vcs-authorize/)

![Login circleCI](/img/ci-cd-pic2.png "login circleCI")

* Chá»n login báº±ng github vÃ  thá»±c hiá»‡n

![Set up project](/img/ci-cd-pic3.png "set up project")

* Sau khi báº¥m vÃ o `Set Up Project` chÃºng ta sáº½ tháº¥y Ä‘oáº¡n mÃ£ config dÃ nh cho Node nhÆ° sau:

```
version: 2.1
orbs:
  node: circleci/node@3.0.0
workflows:
  node-tests:
    jobs:
      - node/test
```
 * `version`: phiÃªn báº£n cá»§a circleCI
 * `orbs`: lÃ  nÆ¡i khai bÃ¡o command line Ä‘Æ°á»£c há»— trá»£ bá»Ÿi circle. Sá»­ dá»¥ng command cá»§a node.
 * `workflows`: cÃ¡c luá»“ng cháº¡y trÃªn project:
	 * `node-tests` tÃªn flow tá»± Ä‘áº·t.
	 * jobs: cÃ¡c job cáº§n cháº¡y cho project.
	 * `node/test` lÃ  lá»‡nh máº·c Ä‘á»‹nh cá»§a command node - thá»© mÃ  Ä‘Ã£ Ä‘Æ°á»£c khai bÃ¡o á»Ÿ `orbs`. BÃ¬nh thÆ°á»ng náº¿u khÃ´ng cÃ³ sá»± há»— trá»£ nÃ y ta sáº½ pháº£i cháº¡y lá»‡nh tÆ°Æ¡ng tá»± nhÆ° `npm run test`.
 * Sau Ä‘Ã³ chá»n `Add config` Ä‘á»ƒ tiáº¿p tá»¥c thá»±c hiá»‡n build trÃªn CircleCI.
 * ChÃºng ta sáº½ tháº¥y quÃ¡ trÃ¬nh cháº¡y

![running](/img/ci-cd-pic4.png "runnig")

* CÃ³ thá»ƒ xem cháº¡y cá»¥ thá»ƒ tá»«ng step cá»§a tá»«ng bÆ°á»›c báº±ng cÃ¡ch click vÃ o `node-test` trong workflow.
* Láº§n Ä‘áº§u cháº¡y sáº½ bá»‹ fail, vÃ¬ chÃºng ta cÃ²n thiáº¿u má»™t vÃ i config ná»¯a.

#### 2.2 Tiáº¿n hÃ nh config CI
* Quay trá»Ÿ láº¡i vá»›i project trÃªn mÃ¡y local. Ta cáº§n táº¡o 1 thÆ° má»¥c `.circleci` theo Ä‘Ãºng quy Ä‘á»‹nh cá»§a CircleCI. Trong `.circleci` táº¡o file `config.yml` nhÆ° sau:

```yaml
version: 2.1
orbs:
  node: circleci/node@3.0.0
jobs:
  build:
    docker:
      # specify the version you desire here
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # sá»­ dá»¥ng mÃ´i trÆ°á»ng cháº¡y nodejs thÃ´ng quan docker
      - image: circleci/node:12.13.0

    working_directory: ~/todo-typescript

    steps:
      - checkout
      # khÃ´i phá»¥c láº¡i folder chá»©a package (v1-dependencies) dá»±a vÃ o file (package-lock.json)
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package-lock.json" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - run: npm install
      # lÆ°u láº¡i cache folder theo key náº¿u nhÆ° (package-lock.json) cÃ³ sá»± thay Ä‘á»•i
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}

      - run: npm run test
```
* Má»i thá»© Ä‘á»u Ä‘Æ°á»£c mÃ¬nh giáº£i thÃ­ch á»Ÿ comment tÆ°Æ¡ng á»©ng.
* `npm run test` chÃ­nh lÃ  cháº¡y test case cá»§a project. Äoáº¡n script nÃ y Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong file `package.json`.
* Ok! bÃ¢y giá» hÃ£y commit vÃ  push lÃªn github nhÃ©. ChÃºng ta theo dÃµi tiáº¿p trÃªn `Pipelines` cá»§a circleCI.
* Káº¿t quáº£: Success xanh lÃ¨ ğŸ¤£
![success](/img/ci-cd-pic5.png "test success")
* Tá»©c lÃ  CI cá»§a chÃºng ta Ä‘Ã£ hoáº¡t Ä‘á»™ng cÅ©ng nhÆ° test case Ä‘Ã£ Ä‘Æ°á»£c pass. Náº¿u khi cÃ³ 1 test case nÃ o chÆ°a pass thÃ¬ sáº½ bá»‹ bÃ¡o fail.

#### 2.3 Tiáº¿n hÃ nh deploy lÃªn server.
* Äáº§u tiÃªn chÃºng ta sáº½ thá»­ ssh vÃ o server Ä‘á»ƒ cháº¡y project má»™t cÃ¡ch thá»§ cÃ´ng.
* `cd /home` vÃ  `git clone git@github.com:dattp/todo_typescript.git` sá»­ dá»¥ng ssh Ä‘á»ƒ clone nhÃ©.
* Náº¿u báº¡n chÆ°a cÃ³ ssh-key thÃ¬ search trÃªn gg Ä‘á»ƒ add public-key vÃ o github nha ğŸ˜œ
* Báº¡n cáº§n gen ra 2 key. Má»™t key trÃªn mÃ¡y local Ä‘á»ƒ ssh vÃ o server. VÃ  má»™t key trÃªn server, sau Ä‘Ã³ add key server nÃ y vÃ o pháº§n setting ssh key cá»§a github Ä‘á»ƒ cÃ³ thá»ƒ clone Ä‘Æ°á»£c project vá».
* Sau khi Ä‘Ã£ clone Ä‘Æ°á»£c project vá» chÃºng ta sáº½ thá»­ start server lÃªn nha.
* Khi Ä‘Ã£ ssh Ä‘Æ°á»£c vÃ o server thÃ´ng qua ssh key mÃ  khÃ´ng cáº§n nháº­p máº­t kháº©u. ChÃºng ta sáº½ tiáº¿p tá»¥c config trÃªn circleCI nhÆ° sau.
* Chá»n `Project Setting` 
![Project Setting](/img/ci-cd-pic6.png "project setting")
* Chá»n `SSH Keys` á»Ÿ cá»™t menu bÃªn trÃ¡i.
* Chá»n `Add SSH Key` trong má»¥c `Additional SSH Keys`
![Add SSH Key](/img/ci-cd-pic7.png "add ssh key")

* Paste private key - cÃ¡i mÃ  báº¡n Ä‘Ã£ gen Ä‘Æ°á»£c ra á»Ÿ trÃªn mÃ¡y local. (paste cáº£ pháº§n header vÃ  footer tá»©c lÃ  pháº§n -----BEGIN RSA PRIVATE KEY----- cho háº¿t -----END RSA PRIVATE KEY----- nha)
* Ngay sau khi add Ä‘Æ°á»£c ssh key. ChÃºng ta sáº½ cÃ³ `Fingerprint` tÆ°Æ¡ng á»©ng nhÆ° sau:
![fingerprint](/img/ci-cd-pic8.png "fingerprint")

* Quay trá»Ÿ láº¡i vá»›i file config cá»§a circleCI trÃªn mÃ¡y local vÃ  hoÃ n thiá»‡n nÃ³:

```yaml
version: 2.1
orbs:
  node: circleci/node@3.0.0
jobs:
  build:
    docker:
      # specify the version you desire here
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # sá»­ dá»¥ng mÃ´i trÆ°á»ng cháº¡y nodejs thÃ´ng quan docker
      - image: circleci/node:12.13.0

    working_directory: ~/todo-typescript

    steps:
      - checkout
      # khÃ´i phá»¥c láº¡i folder chá»©a package (v1-dependencies) dá»±a vÃ o file (package-lock.json)
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package-lock.json" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - run: npm install
      # lÆ°u láº¡i cache folder theo key náº¿u nhÆ° (package-lock.json) cÃ³ sá»± thay Ä‘á»•i
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}

      - run: npm run test

  deploy:
    machine:
      enabled: true
    steps:
      - add_ssh_keys:
          fingerprints:
            - "76:8d:4d:4c:2c:db:3f:0d:a6:6e:5a:42:f4:dc:c5:23"
      - run: 
          name: pull code and start api_services
          command: ssh -oStrictHostKeyChecking=no root@42.112.27.132 -p 87222 "cd /home/todo_typescript; git pull origin master; npm run install-npm; npm run dev"

workflows:
  my-flow:
      jobs:
        - build
        - deploy:
            requires:
              - build
            filters:
              branches:
                only:
                  - master
```
* ChÃºng ta bá»• sung thÃªm má»™t job má»›i cÃ³ tÃªn lÃ  `deploy` sá»­ dá»¥ng machine máº·c Ä‘á»‹nh.
* MÃ´ táº£ cÃ¡c bÆ°á»›c cáº§n thá»±c hiá»‡n:
	* add ssh key dá»±a vÃ o `fingerprints` - cÃ¡i mÃ  Ä‘Ã£ láº¥y Ä‘Æ°á»£c á»Ÿ bÆ°á»›c trÃªn.
	* `run` cÃ¡c commands tÆ°Æ¡ng á»©ng. Äáº§u tiÃªn lÃ  ssh vÃ o server vá»›i option `oStrictHostKeyChecking = no` Ä‘á»ƒ khÃ´ng hiá»ƒn thá»‹ cÃ¢u há»i yes/no khi ssh.
	* Sau khi vÃ o Ä‘Æ°á»£c server. ChÃºng ta sáº½ di chuyá»ƒn Ä‘áº¿n project - cÃ¡i mÃ  ta Ä‘Ã£ clone cháº¡y thá»­ á»Ÿ bÆ°á»›c phÃ­a trÃªn.
	* Sau Ä‘Ã³ thá»±c hiá»‡n pull code master vá», install láº¡i npm vÃ  cuá»‘i cÃ¹ng lÃ  start server.
	* `workflows` lÃ  nÆ¡i ta Ä‘á»‹nh nghÄ©a luá»“ng cáº§n thá»±c hiá»‡n:
		* tÃªn flow: `my-flow`
		* jobs cáº§n cháº¡y: Äáº§u tiÃªn lÃ  `build` Ä‘á»ƒ cháº¡y cÃ¡c test case.  
		* Sau Ä‘Ã³ sáº½ cháº¡y job `deploy.`Require `build` á»Ÿ Ä‘Ã¢y muá»‘n job `build` pháº£i SUCCESS thÃ¬ deploy má»›i Ä‘Æ°á»£c cháº¡y. VÃ  chá»‰ cháº¡y deploy khi cÃ³ code Ä‘Æ°á»£c meger vÃ o nhÃ¡nh master.
* BÃ¢y giá» chÃºng ta sáº½ thá»­ thay Ä‘á»•i 1 Ä‘oáº¡n code nhá». Sau Ä‘Ã³ commit code lÃªn github. 
* Khi meger nhÃ¡nh vá»«a push lÃªn vÃ o master. ThÃ¬ nÃ³ sáº½ tá»± Ä‘á»™ng deploy lÃªn server.

![Deploying](/img/ci-cd-pic9.png "deploying")
* QuÃ¡ trÃ¬nh deploy sáº½ luÃ´n bá»‹ giá»¯ á»Ÿ tráº¡ng thÃ¡i running do nÃ³ Ä‘ang giá»¯ command start server. LÃºc nÃ y chÃºng ta sáº½ sá»­ dá»¥ng package `pm2` Ä‘á»ƒ cháº¡y tiáº¿n trÃ¬nh cá»§a project nhÃ©.
* CÃ³ thá»ƒ chá»n 2 cÃ¡ch. Má»™t lÃ  bá»• sung thÃªm Ä‘oáº¡n `sudo npm install pm2 -g` trong job deploy. Äá»ƒ khi deploy nÃ³ sáº½ tá»± Ä‘á»™ng cÃ i `pm2` hoáº·c cÃ i trá»±c tiáº¿p `pm2` trÃªn server.
* Sá»­a láº¡i Ä‘oáº¡n code trong package.json: `pm2 start nodemon` cháº¡y development mode.
* Káº¿t quáº£:
![pipeline](/img/ci-cd-pic10.png "pipeline")
* ChÃºng ta cÃ³ success á»Ÿ cáº£ 2 jobs `build` vÃ  `deploy` ğŸ˜.  Báº¡n hÃ£y check thá»­ trÃªn server nhÃ©.

### 3. Káº¿t luáº­n gÃ¬ á»Ÿ Ä‘Ã¢y
* NhÆ° má»i ngÆ°á»i tháº¥y, khi Ä‘Ã£ tÃ­ch há»£p CI/CD vÃ o, má»i thá»© trá»Ÿ nÃªn tá»± Ä‘á»™ng. Tá»± Ä‘á»™ng deploy lÃªn server nÃªn viá»‡c viáº¿t test case lÃ  ráº¥t ráº¥t quan trá»ng. NÃ³ sáº½ kiá»ƒm soÃ¡t nhá»¯ng sá»± thay Ä‘á»•i cÃ³ trong code, cÃ³ áº£nh hÆ°á»Ÿng gÃ¬ Ä‘áº¿n cÃ¡c hÃ m Ä‘ang cháº¡y khÃ´ng.
* Do váº­y viáº¿t unit test cÃ ng cáº©n tháº­n cÃ ng tá»‘t. Tá»‘t nháº¥t lÃ  nÃªn coverage Ä‘Æ°á»£c toÃ n bá»™ cÃ¡c hÃ m - khÃ´ng cÃ²n dÃ²ng code nÃ o xuáº¥t hiá»‡n trÃªn cá»™t `Uncovered Line #s` khi cháº¡y test vá»›i `Jest`.
* NhÆ° vÃ­ dá»¥ trÃªn mÃ¬nh cháº¡y vá»›i project Ä‘Æ¡n giáº£n. ChÆ°a cÃ³ tÆ°Æ¡ng tÃ¡c vá»›i `Database` nÃªn viá»‡c viáº¿t test cÅ©ng Ä‘Æ¡n giáº£n. á» nhá»¯ng bÃ i tiáº¿p theo náº¿u cÃ³ Ä‘iá»u kiá»‡n mÃ¬nh sáº½ viáº¿t thÃªm vá» test vá»›i `DB` tá»« viá»‡c chuáº©n bá»‹ dá»¯ liá»‡u test, xoÃ¡ dá»¯ liá»‡u sau khi cháº¡y xong test.
* Báº£n thÃ¢n mÃ¬nh khi Ã¡p dá»¥ng CI/CD vÃ o project cÅ©ng má»›i báº¯t Ä‘áº§u chÃº trá»ng vÃ o viá»‡c viáº¿t test hÆ¡n, nÃªn trong bÃ i cÃ³ thá»ƒ cÃ³ nhá»¯ng cÃ¡i chÆ°a Ä‘Æ°á»£c phÃ¹ há»£p. Ráº¥t mong cÃ³ sá»± gÃ³p Ã½ cá»§a má»i ngÆ°á»i.